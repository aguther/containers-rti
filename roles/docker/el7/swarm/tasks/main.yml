---
- name: pull images
  docker_image:
    name: "{{ item }}"
  with_items:
    - swarm
    - progrium/consul
    - gliderlabs/registrator
    - rethinkdb
    - shipyard/shipyard

- name: "consul : create data directory"
  file:
    path: /var/lib/consul
    state: directory

- name: "consul : run"
  docker_container:
    name: consul
    image: progrium/consul
    hostname: consul
    command: "-server -advertise {{ inventory_hostname }} -client 0.0.0.0 -bootstrap -ui-dir /ui"
    state: present
    recreate: yes
    exposed_ports:
      - "{{ inventory_hostname }}:8300:8300"
      - "{{ inventory_hostname }}:8301:8301"
      - "{{ inventory_hostname }}:8301:8301/udp"
      - "{{ inventory_hostname }}:8302:8302"
      - "{{ inventory_hostname }}:8302:8302/udp"
      - "{{ inventory_hostname }}:8400:8400"
      - "{{ inventory_hostname }}:8500:8500"
      - "{{ inventory_hostname }}:53:53/udp"
    volumes:
      - "/var/lib/consul:/data"
  when: inventory_hostname in groups['master']

- name: "registrar : run"
  docker_container:
    name: registrar
    image: gliderlabs/registrator
    hostname: registrar
    command: "consul://{{ inventory_hostname }}:8500"
    state: present
    recreate: yes
    volumes:
      - "/var/run/docker.sock:/tmp/docker.sock"
  when: inventory_hostname in groups['master']

- name: "swarm : run agent"
  docker_container:
    name: sagent
    image: swarm
    hostname: sagent
    command: "join -advertise={{ inventory_hostname }}:2375 consul://{{ groups['master'][0] }}:8500"
    state: present
    recreate: yes

- name: "swarm : run manager"
  docker_container:
    name: smanager
    image: swarm
    hostname: smanager
    command: "manage consul://{{ inventory_hostname }}:8500"
    state: present
    recreate: yes
    exposed_ports:
      - "2400:2375"

#- name: print swarm info
#  shell: "docker -H tcp://{{ groups['master'][0] }}:2400 info"
#
#- name: list swarm nodes
#  shell: "docker run --rm swarm list consul://{{ groups['master'][0] }}:8500"
#
#- name: list containers in swarm
#  shell: "docker -H tcp://{{ groups['master'][0] }}:2400 ps"

# List containers in swarm:   docker -H tcp://{{ groups['master'][0] }}:2400 ps
# Example how to start image: docker -H tcp://{{ groups['master'][0] }}:2400 run -d -name web nginx
...
