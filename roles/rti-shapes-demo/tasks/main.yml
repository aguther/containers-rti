---
- name: delete service
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      delete service
        {{ item }}
  ignore_errors: yes
  with_items:
    - rti-routing-service
    - rti-cloud-discovery-service
 
- name: delete pods
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      delete pod
        {{ item }}
  ignore_errors: yes
  with_items:
    - shape-publisher-square-blue
    - shape-subscriber-square
    - rti-routing-service
    - rti-cloud-discovery-service

- name: create config map for rti-cloud-discovery-service
  include: create-configmap.yml
  vars:
    config_map_name: rti-shapes-demo-rti-cloud-discovery-service
    config_map_path: "rti-cloud-discovery-service"

- name: create config map for rti-routing-service
  include: create-configmap.yml
  vars:
    config_map_name: rti-shapes-demo-rti-routing-service
    config_map_path: "rti-routing-service"

- name: "pod : copy definition"
  copy:
    src: "{{ item }}"
    dest: "/tmp/{{ item }}"
  with_items:
    - rti-cloud-discovery-service.yml
    - rti-routing-service.yml
    - shape-publisher.yml
    - shape-subscriber.yml

- name: "pod : apply definition for rti-cloud-discovery-service"
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      apply
        --filename /tmp/{{ item }}
  with_items:
    - rti-cloud-discovery-service.yml

- name: "pod: wait for rti-cloud-discovery-service to be ready"
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      wait pod
        --for condition=ready
        --selector app==rti-cloud-discovery-service
        --timeout=60s

- name: "pod : create service for cloud discovery"
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      expose pod
        rti-cloud-discovery-service
        --port=7400
        --target-port=7400
        --protocol=UDP

- name: "pod : apply definition"
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      apply
        --filename /tmp/{{ item }}
  with_items:
    - rti-routing-service.yml
    - shape-publisher.yml
    - shape-subscriber.yml

- name: "pod : clean-up definition"
  file:
    path: "/tmp/{{ item }}"
    state: absent
  with_items:
    - rti-cloud-discovery-service.yml
    - rti-routing-service.yml
    - shape-publisher.yml
    - shape-subscriber.yml

- name: expose port
  command: >
    /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf
      expose pod
        rti-routing-service
        --port=7650
        --protocol=TCP
        --target-port=rtps2-tcp
        --external-ip=172.30.0.11
