---
- name: add repository
  yum_repository:
    file: kubernetes
    name: kubernetes
    description: Kubernetes
    baseurl: http://yum.kubernetes.io/repos/kubernetes-el7-x86_64
    gpgkey: |
      https://packages.cloud.google.com/yum/doc/yum-key.gpg
       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
    gpgcheck: yes
    repo_gpgcheck: yes
    state: present

- name: install
  yum:
    name:
      - kubelet
      - kubeadm
      - kubectl
      - kubernetes-cni
    state: latest
    update_cache: yes
    disable_gpg_check: yes

- name: enable and start kubelet
  service:
    name: kubelet.service
    state: running
    enabled: yes

- name: init master
  shell: "kubeadm init"
  register: kubeadm_init
  when: inventory_hostname in groups['master']

- name: get master token
  shell: "echo '{{ kubeadm_init.stdout }}' | tail -n1 | awk '{print $3}'"
  register: kubeadm_token
  when: inventory_hostname in groups['master']

- name: install bash completion for kubectl
  shell: "kubectl completion bash > /etc/bash_completion.d/kubectl.bash"
  when: inventory_hostname in groups['master']

- name: ensure node /etc/kubernetes is empty
  file:
    path: "{{ item }}"
    state: absent
  with_fileglob:
    - /etc/Kubernetes/*
  when: inventory_hostname in groups['nodes']

- name: init node
  shell: "kubeadm join {{ hostvars[groups['master'][0]].kubeadm_token.stdout }} {{ groups['master'][0] }}"
  when: inventory_hostname in groups['nodes']
