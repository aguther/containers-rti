---
- name: install dashboard
  command: /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f https://raw.githubusercontent.com/kubernetes/dashboard/master/src/deploy/recommended/kubernetes-dashboard.yaml
  register: dashboard_raw
  when: (inventory_hostname == groups['master'][0])

- name: create RBAC for dashboard
  command: /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf create clusterrolebinding permissive-binding --clusterrole=cluster-admin --user=admin --user=kubelet --group=system:serviceaccounts
  register: rbac_raw
  ignore_errors: true
  when: (inventory_hostname == groups['master'][0])

- name: change service to NodePort
  command: /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf patch service kubernetes-dashboard -p '{"spec":{"type":"NodePort"}}' --namespace=kube-system
  when: (inventory_hostname == groups['master'][0])

- name: set NodePort to fixed value of 30000
  command: /usr/bin/kubectl --kubeconfig=/etc/kubernetes/admin.conf patch service kubernetes-dashboard -p '{"spec":{"ports":[{"port":443,"nodePort":30000}]}}' --namespace=kube-system
  when: (inventory_hostname == groups['master'][0])
