---
- name: "create etcd-server"
  command: >
    /usr/bin/kubeadm init phase certs etcd-server
      --config=/etc/kubernetes/kubeadm-etcd.yml
  args:
    creates: /etc/kubernetes/pki/etcd/server.*

- name: "create etcd-peer"
  command: >
    /usr/bin/kubeadm init phase certs etcd-peer
      --config=/etc/kubernetes/kubeadm-etcd.yml
  args:
    creates: /etc/kubernetes/pki/etcd/peer.*

- name: "create etcd-healthcheck-client"
  command: >
    /usr/bin/kubeadm init phase certs etcd-healthcheck-client
      --config=/etc/kubernetes/kubeadm-etcd.yml
  args:
    creates: /etc/kubernetes/pki/etcd/healthcheck-client.*

- name: "create apiserver-etcd-client"
  command: >
    /usr/bin/kubeadm init phase certs apiserver-etcd-client
      --config=/etc/kubernetes/kubeadm-etcd.yml
  args:
    creates: /etc/kubernetes/pki/apiserver-etcd-client.*

- name: "correct permissions"
  file:
    dest: "/etc/kubernetes/pki/{{ item }}"
    owner: root
    group: root
    mode: 0644
  with_items:
    - apiserver-etcd-client.crt
    - apiserver-etcd-client.key
    - etcd/healthcheck-client.crt
    - etcd/healthcheck-client.key
    - etcd/peer.crt
    - etcd/peer.key
    - etcd/server.crt
    - etcd/server.key
