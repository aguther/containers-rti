---
# ------------------------------------------------------------------------------
- name: install
  yum:
    name: flannel
    state: latest

# ------------------------------------------------------------------------------
- name: check network config in etcd
  command: "etcdctl --endpoints \"{{ flannel_etcd_url }}\" get \"/atomic.io/network/config\""
  register: etcd_network_config
  failed_when: etcd_network_config.stderr.find('Key not found') != -1
  changed_when: false

# ------------------------------------------------------------------------------
- name: set FLANNEL_ETCD_ENDPOINTS
  command: "sed -i 's/\\(FLANNEL_ETCD_ENDPOINTS=\"\\).*\\(\"\\)/\\1{{ item }}\\2/g' /etc/sysconfig/flanneld"
  with_items: "{{ flannel_etcd_url }}"

# ------------------------------------------------------------------------------
- name: enable and start
  service:
    name: flanneld.service
    state: running
    enabled: yes
